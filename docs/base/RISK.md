# RISK.md — RiskManager 클래스 명세

## 0. 이 문서의 지위

이 문서는 **BASE_ARCHITECTURE.md의 하위 문서**다.

> **BASE_ARCHITECTURE.md가 "Risk Manager는 노출 허가 판단"이라 했으므로,
> 이 문서는 그 허가 기준만 정의한다.**

구조 결정 권한: BASE_ARCHITECTURE.md
리스크 정책 정의 권한: 이 문서

**클래스 매핑**: RiskManager

---

## 1. 기본 선언

이 시스템에서 리스크는 제거 대상이 아니다.

> **리스크는 의도적으로 사용되는 도구다.**

---

## 1. 리스크 구조의 핵심

- 평상시: 리스크 제한
- 특정 조건: 리스크 해제 또는 완화

---

## 2. 허용 손실 구조

- 단일 트레이드 손실: 계좌의 10~30%까지 허용
- 단, **청산 확률은 0에 가깝게 유지**

이유:
- 작은 계좌는 작은 리스크로 커질 수 없다

---

## 3. 실패 허용 횟수 개념

이 시스템은 다음을 전제로 한다:

> **5번의 시도 중  
4번은 실패해도 된다.  
1번만 크게 성공하면 된다.**

---

## 4. 리스크 차단 조건

다음은 반드시 차단한다:

- 구조적 손실 (Convexity 폭발)
- 마진 급감
- 시스템 오류

---

## 5. 리스크 요약

| 항목 | 기준 |
|---|---|
| Drawdown | 비용 |
| 실패 | 전제 |
| 청산 | 금지 |
| 생존 | 수단 |
| 목표 | 계좌 점프 |

---

## 6. 이 문서의 역할

> 이 리스크 모델은
'계좌를 보호하기 위해' 존재하지 않는다.
**'계좌를 키우기 위해
어디까지 위험을 써도 되는지'
정의하기 위해 존재한다.**

---

## 7. 자본 보존 체계

### 7.1 연속 실패 감지 및 대응

**실패 정의**:
- 손절가 도달로 청산된 거래
- 미실현 손실 -12% 초과 후 청산

**대응 단계**:

| 연속 실패 | 조치 | 리스크 조정 | Layer 제한 |
|-----------|------|-------------|------------|
| 1~2연패 | 정상 운용 | 100% | 3-Layer |
| 3연패 | 리스크 축소 | 80% | 3-Layer |
| 4연패 | 확장 금지 | 50% | 1-Layer |
| 5연패 | COOLDOWN | 0% | 거래 중단 |

**리스크 조정 적용**:
```python
조정된 리스크 = 기본 리스크 × 리스크 조정 비율

예시:
- 기본 Layer 1: 5%
- 3연패 후: 5% × 0.8 = 4%
- 4연패 후: 5% × 0.5 = 2.5% (Layer 1만)
```

**복구 조건**:
- 2연승 시: 한 단계 복구
- 4연승 시: 정상 운용 복귀

---

### 7.2 COOLDOWN 메커니즘

**진입 조건** (하나라도 충족 시):
1. 5연패 도달
2. 단일 거래 손실 > 20% (청산가 도달)
3. 7일 누적 손실 > 40%

**COOLDOWN 기간**:
- 기본: 72시간 (3일)
- 손실 >30% 시: 120시간 (5일)
- 청산가 도달 시: 168시간 (7일)

**COOLDOWN 중 활동**:
- 실거래: 중단
- Paper Trading: 진행 (조건 확인용)
- 시장 분석: 지속
- 전략 검토: 필수

**재개 조건** (모두 충족):
1. COOLDOWN 기간 경과
2. ATR 정상화: `ATR(14) > EMA(ATR, 50) * 1.0`
3. Paper Trading 3연승
4. 시장 환경 확인:
   - 트렌드 명확성
   - 변동성 안정

**목적**: 시장 환경 악화 또는 전략 불일치 시 자본 보호

---

### 7.3 계좌 Tier별 리스크 프로파일

**Tier 분류 및 리스크 설정**:

| Tier | 계좌 구간 | 기본 리스크 | Layer | 최대 레버 | 목표 |
|------|-----------|-------------|-------|-----------|------|
| 1 | $100-70 | 15% | 3-Layer | 5x | 성장 |
| 2 | $70-50 | 10% | 2-Layer | 4x | 균형 |
| 3 | $50-30 | 8% | 1-Layer | 3x | 보존 |
| 4 | <$30 | 0% | Paper | - | 재건 |

**Tier 전환 규칙**:
- 계좌 감소 시: 즉시 하위 Tier 적용
- 계좌 증가 시: 2거래 후 상위 Tier 적용 (안정성 확인)

**Tier 4 처리**:
- 실거래 중단
- Paper Trading으로 전환
- 추가 입금 검토 또는
- 전략 재평가 후 재시작

**예시**:
```
계좌: $100 → $68 (32% 손실)
- 즉시 Tier 2 적용
- Layer 3 차단
- 레버리지 최대 4x

계좌: $68 → $28 (추가 손실)
- 즉시 Tier 4 적용
- 실거래 중단
- Paper Trading 전환
```

---

### 7.4 Drawdown 관리 체계

**Drawdown 정의**:
```
Drawdown = (최고점 - 현재 잔고) / 최고점 × 100%
```

**Drawdown 레벨 및 대응**:

| Level | DD 구간 | 상태 | 조치 |
|-------|---------|------|------|
| 1 | -15 ~ -25% | 정상 | 감시 |
| 2 | -25 ~ -35% | 경고 | 리스크 80%, Layer 3 차단 |
| 3 | -35 ~ -50% | 위험 | 리스크 50%, 72h COOLDOWN |
| 4 | > -50% | 임계 | 거래 중단, 전략 재평가 |

**Level별 세부 조치**:

**Level 2 (DD -25~-35%)**:
- Layer 1 크기: 15% → 12%
- Layer 2 크기: 8% → 6%
- Layer 3: 차단
- 확장 조건 강화: +8% → +10%

**Level 3 (DD -35~-50%)**:
- Layer 1만 허용, 크기 8%
- 72시간 COOLDOWN 강제
- 재개 시 Level 2 조치 유지
- 5연승 후 정상화

**Level 4 (DD >-50%)**:
- 모든 거래 중단
- 전략 전면 재검토:
  - 백테스트 재검증
  - 파라미터 재조정
  - 시장 환경 분석
- 재시작은 Paper Trading부터

**회복 경로**:
- DD가 한 단계 개선 + 2연승: 상위 Level 복귀
- Level 4 → 1 복귀: 최소 4주 + 10연승 필요

---

### 7.5 동적 리스크 조정 알고리즘

**최종 리스크 계산식**:
```python
최종 리스크 = Base × Performance × DD × Volatility × Account

여기서:
Base = 기본 리스크 (Tier별 설정)
Performance = 성과 계수 (0.5 ~ 1.2)
DD = Drawdown 계수 (0.5 ~ 1.0)
Volatility = 변동성 계수 (0.8 ~ 1.2)
Account = 계좌 크기 계수 (0.8 ~ 1.2)
```

**Performance 계수**:
```python
최근 10거래 승률 기반:
- 승률 >= 60%: 1.2
- 승률 40-60%: 1.0
- 승률 20-40%: 0.8
- 승률 < 20%: 0.5

연속 실패 추가 페널티:
- 3연패: × 0.8
- 4연패: × 0.5
```

**DD 계수**:
```python
Drawdown Level 기반:
- Level 1: 1.0
- Level 2: 0.8
- Level 3: 0.5
- Level 4: 0.0
```

**Volatility 계수**:
```python
현재 ATR vs 평균 ATR:
- ATR > EMA(ATR) * 1.3: 1.2 (확장)
- ATR > EMA(ATR) * 1.0: 1.0 (정상)
- ATR < EMA(ATR) * 1.0: 0.8 (축소)
- ATR < EMA(ATR) * 0.7: 0.5 (대폭 축소)
```

**Account 계수**:
```python
계좌 성장 단계:
- Tier 1 ($100-70): 1.2 (공격적)
- Tier 2 ($70-50): 1.0 (정상)
- Tier 3 ($50-30): 0.8 (보수적)
- Tier 4 (<$30): 0.0 (중단)
```

**적용 예시**:
```
상황: Tier 1 계좌, DD -20%, 3연패, 낮은 ATR

Base = 15% (Tier 1)
Performance = 0.8 (3연패) × 0.5 (승률 <20%) = 0.4
DD = 1.0 (Level 1)
Volatility = 0.8 (ATR 낮음)
Account = 1.2 (Tier 1)

최종 리스크 = 15% × 0.4 × 1.0 × 0.8 × 1.2 = 5.76%
→ Layer 1 크기를 15%에서 5.76%로 축소
```

---

## 8. 리스크 관리 체크리스트

**거래 시작 전**:
- [ ] 계좌 Tier 확인
- [ ] Drawdown Level 확인
- [ ] 연속 실패 횟수 확인
- [ ] COOLDOWN 상태 확인
- [ ] 동적 리스크 계산 및 적용

**거래 중**:
- [ ] 청산가 거리 모니터링 (>= ATR * 3.0)
- [ ] DD Level 변경 감지
- [ ] 확장 차단 조건 체크

**거래 후**:
- [ ] 승패 기록 (연속 실패 추적)
- [ ] Drawdown 갱신
- [ ] Performance 계수 업데이트
- [ ] COOLDOWN 진입 조건 체크

**주간 점검**:
- [ ] 7일 누적 손실 확인 (>40% 시 COOLDOWN)
- [ ] 최고점 대비 DD 확인
- [ ] Tier 전환 필요성 검토
- [ ] 리스크 파라미터 백테스트 재검증

---

## 9. BASE_ARCHITECTURE.md와의 관계

이 문서는:
- **구조를 결정하지 않는다** (BASE가 결정)
- **리스크 정책만 정의한다**
- RiskManager 클래스의 명세서

BASE_ARCHITECTURE.md가 "Risk는 EV Pre-filter 통과 후 호출"이라 했으므로,
이 문서는 EV 통과한 트레이드 중 "노출 허용 여부"를 판단하는 기준을 정의한다.

**역할 분리 명확.**
