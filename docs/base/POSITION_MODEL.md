# POSITION_MODEL.md — PositionSizer 클래스 명세

## 0. 이 문서의 지위

이 문서는 **BASE_ARCHITECTURE.md의 하위 문서**다.

> **BASE_ARCHITECTURE.md가 "Position Sizer는 사이징 계산"이라 했으므로,
> 이 문서는 그 계산 공식만 정의한다.**

구조 결정 권한: BASE_ARCHITECTURE.md
사이징 공식 정의 권한: 이 문서

**클래스 매핑**: PositionSizer

이 문서가 없다면,
이 시스템은 그냥 도박이다.

---

## 1. 포지션의 기본 개념

- 손실 구간에서는 작게
- 수익 구간에서는 크게

> **포지션은 ‘예측’이 아니라  
‘확신이 쌓일수록 커져야 한다.’**

---

## 2. 공격 구간 정의

다음 조건에서 공격적 사이징 허용:

- 방향성 유지
- 변동성 증가
- 미실현 수익 발생 중

---

## 3. 사이징 철학

- 초기 진입: 작게
- 가격이 맞으면: 확대
- 틀리면: 빠르게 정리

---

## 4. 목표 구조

- 손실 1R
- 기대 수익 5~15R

---

## 5. 요약

> 이 시스템에서 포지션은
'계좌를 지키는 도구'가 아니라
**'계좌를 밀어 올리는 레버'다.**

---

## 6. 3-Layer 확장 시스템

### 6.1 레이어 구조 및 크기

**기본 구조** (계좌 $100 기준):

```
Layer 1: $5 (5%), 레버리지 3x → 노출 $15
Layer 2: $8 (8%), 레버리지 4x → 노출 $32 (at +8% 수익)
Layer 3: $10 (10%), 레버리지 5x → 노출 $50 (at +18% 수익)
───────────────────────────────────────────────
총 투입: $23 (23%)
총 노출: $97 (97%)
평균 레버리지: 4.2x
```

**핵심 원칙**:
- 각 레이어는 **수익 구간에서만** 추가
- 손실 구간에서는 Layer 1만 유지
- 최대 레버리지 5x 초과 금지

---

### 6.2 확장 타이밍 및 조건

**Layer 2 진입 조건**:
1. 미실현 수익 +8% 도달
2. 2-4% 되돌림 대기 (저점 진입)
3. 방향성 유지 확인:
   - EMA20 방향 유지
   - ATR > EMA(ATR, 50) * 1.1

**Layer 3 진입 조건**:
1. 미실현 수익 +18% 도달
2. 강한 모멘텀 확인:
   - 최근 4개 캔들 중 3개가 방향성 캔들
   - Volume > EMA(Volume, 20) * 1.2
3. 변동성 지속:
   - ATR > EMA(ATR, 50) * 1.15

**급등 시 예외 규칙**:
- +10% 돌파: Layer 2 즉시 진입 (되돌림 대기 생략)
- +22% 돌파: Layer 3 즉시 진입

**목적**: 트렌드가 강할 때 빠르게 포지션 확대

---

### 6.3 확장 중단 신호

다음 조건 중 하나라도 발생 시 확장 중단:

**1. 변동성 소멸**:
- ATR < EMA(ATR, 50) * 1.0

**2. 역방향 압력**:
- ATR * 1.5 크기의 역방향 캔들 발생

**3. 거래량 감소**:
- Volume < EMA(Volume, 20) * 0.7

**4. 추세 약화**:
- EMA20이 수평에 가까워짐 (기울기 < 0.5%)

**처리**: 확장 중단, 기존 포지션 유지, 청산 조건 모니터링

---

### 6.4 청산가 계산 및 관리

**각 레이어의 청산가**:

| Layer | 레버리지 | 청산가 거리 | 손절 거리 | 안전 마진 |
|-------|----------|------------|----------|----------|
| 1 | 3x | -33% | -12% | 21% |
| 2 | 4x | -25% | -10% | 15% |
| 3 | 5x | -20% | -8% | 12% |

**복합 포지션 청산가 계산**:
```
가중 평균 청산가 = Σ(청산가 * 포지션 크기) / 총 포지션 크기
```

**안전 규칙**:
- 청산가와 손절가 간격: 최소 ATR(14) * 3.0
- 간격 미달 시: 레버리지 축소 또는 Layer 3 포기
- 급변동 시: 전체 포지션 재계산

**예시** (Long 포지션, 진입가 $50,000):
```
Layer 1: 진입 $50,000, 청산가 $33,500, 스톱 $44,000
Layer 2: 진입 $54,000 (+8%), 청산가 $40,500, 스톱 $48,600
Layer 3: 진입 $59,000 (+18%), 청산가 $47,200, 스톱 $54,280

복합 청산가: $42,150 (가중 평균)
복합 스톱: $49,500 (가중 평균 -12%)
```

---

### 6.5 계좌 구간별 노출 한도

계좌 크기에 따라 최대 노출 및 레버리지 제한:

| 계좌 구간 | 최대 노출 | 최대 레버리지 | Layer 제한 |
|-----------|-----------|---------------|------------|
| $100-200 | 100% | 5x | 3-Layer |
| $200-500 | 80% | 4x | 2-Layer |
| $500-1000 | 60% | 3x | 1-Layer |
| $1000+ | 40% | 3x | 1-Layer |

**목적**:
- 소액 계좌: 공격적 확장 허용 (계좌 점프 필요)
- 중간 계좌: 리스크 점진적 축소
- 고액 계좌: 보수적 운용 (보존 중시)

**적용**:
- 각 거래 시작 전 계좌 크기 확인
- 해당 Tier의 한도 적용
- 거래 중 계좌 크기 변경 시에도 즉시 재조정

---

## 7. 포지션 관리 체크리스트

**진입 전**:
- [ ] 계좌 Tier 확인 및 노출 한도 계산
- [ ] Layer 1 청산가와 손절가 간격 확인 (>= ATR * 3.0)

**확장 전**:
- [ ] 확장 조건 충족 확인 (수익률, 모멘텀, 변동성)
- [ ] 복합 청산가 재계산
- [ ] 안전 마진 유지 확인

**보유 중**:
- [ ] 확장 중단 신호 모니터링
- [ ] 청산 조건 체크 (목표 수익, 손절, 추세 붕괴)

**청산 후**:
- [ ] 실제 수익률 기록
- [ ] Layer별 기여도 분석

---

## 8. BASE_ARCHITECTURE.md와의 관계

이 문서는:
- **구조를 결정하지 않는다** (BASE가 결정)
- **사이징 공식만 정의한다**
- PositionSizer 클래스의 명세서

BASE_ARCHITECTURE.md가 "Position Sizer는 EV Full Validator 통과 후 호출"이라 했으므로,
이 문서는 EV +300% 가능한 트레이드의 "구체적 크기"를 계산하는 공식을 정의한다.

**역할 분리 명확.**
