# docker-compose.yml
# Phase 14b (Dockerization) Phase 2: Multi-Container Orchestration
# Services: bot, (dashboard, analysis는 Phase 3+에서 추가)

version: '3.8'

services:
  # ============================================================
  # Bot Service: Trading Bot (24/7)
  # ============================================================
  bot:
    build:
      context: .
      dockerfile: docker/Dockerfile.bot
      args:
        BASE_IMAGE: cbgb:production
    image: cbgb-bot:latest
    container_name: cbgb-bot
    restart: unless-stopped

    # 환경변수 파일 로드
    env_file:
      - .env  # 로컬 개발용 (.gitignore에 포함)

    # 환경변수 (override 가능)
    environment:
      - BYBIT_TESTNET=${BYBIT_TESTNET:-true}  # 기본값: Testnet
      - PYTHONUNBUFFERED=1
      - GIT_COMMIT=${GIT_COMMIT:-unknown}  # Trade log 코드 버전 추적

    # Volume 마운트
    volumes:
      - cbgb-logs:/app/logs              # 로그 영구 보존
      - cbgb-config:/app/config          # 정책 파일
      - cbgb-evidence:/app/docs/evidence # Gate 증거

    # Network
    networks:
      - cbgb-network

    # Graceful shutdown (30초 대기)
    stop_grace_period: 30s
    stop_signal: SIGTERM

    # 리소스 제한 (선택사항, 프로덕션 권장)
    # deploy:
    #   resources:
    #     limits:
    #       cpus: '1.0'
    #       memory: 512M
    #     reservations:
    #       cpus: '0.5'
    #       memory: 256M

    # 로그 드라이버 설정 (파일 크기 제한)
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"

  # ============================================================
  # Dashboard Service: Streamlit Dashboard (Trade Log Analytics)
  # ============================================================
  dashboard:
    build:
      context: .
      dockerfile: docker/Dockerfile.dashboard
      args:
        BASE_IMAGE: cbgb:production
    image: cbgb-dashboard:latest
    container_name: cbgb-dashboard
    restart: unless-stopped

    # 환경변수 파일 로드 (실시간 포지션 조회를 위해 API credentials 필요)
    env_file:
      - .env

    # 환경변수 (override 가능)
    environment:
      - BYBIT_TESTNET=${BYBIT_TESTNET:-true}
      - PYTHONUNBUFFERED=1

    # 포트 노출 (Streamlit)
    ports:
      - "8501:8501"

    # Volume 마운트 (logs 디렉토리만 read-only)
    volumes:
      - cbgb-logs:/app/logs:ro  # Read-only (Dashboard는 로그 읽기만)
      - cbgb-config:/app/config:ro  # Read-only (정책 파일 읽기)

    # Network
    networks:
      - cbgb-network

    # Graceful shutdown (10초면 충분)
    stop_grace_period: 10s
    stop_signal: SIGTERM

    # 로그 드라이버 설정
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"

  # ============================================================
  # Analysis Service: Cron-based Trade Analysis
  # ============================================================
  analysis:
    build:
      context: .
      dockerfile: docker/Dockerfile.analysis
      args:
        BASE_IMAGE: cbgb:production
    image: cbgb-analysis:latest
    container_name: cbgb-analysis
    restart: unless-stopped

    # Volume 마운트 (logs, reports)
    volumes:
      - cbgb-logs:/app/logs              # 로그 공유 (bot과 동일)
      - cbgb-reports:/app/reports        # 분석 리포트 저장
      - cbgb-config:/app/config:ro       # 정책 파일 읽기

    # Network
    networks:
      - cbgb-network

    # Graceful shutdown (cron 종료)
    stop_grace_period: 10s
    stop_signal: SIGTERM

    # 로그 드라이버 설정
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"

# ============================================================
# Volumes (Named Volumes)
# ============================================================
volumes:
  cbgb-logs:
    driver: local
  cbgb-config:
    driver: local
  cbgb-evidence:
    driver: local
  cbgb-reports:
    driver: local

# ============================================================
# Networks
# ============================================================
networks:
  cbgb-network:
    driver: bridge
